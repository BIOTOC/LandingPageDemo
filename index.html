<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landing Page</title>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.has('id')) {
            const defaultId = HDS2323i4i34232;
            const newUrl = window.location.href + (window.location.href.includes('?') ? '&' : '?') + 'id=' + defaultId;
            window.history.replaceState({}, '', newUrl);
        }
    </script>

    <link rel="stylesheet" href="/css/style.css">

</head>
<body>
    <div class="container">
        <div id="loading" class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Đang khởi động camera...</div>
        </div>

        <div class="angle-buttons" id="angleButtons">
            <button data-angle="goc_cheo_truoc_lai">Trước trái</button>
            <button data-angle="goc_cheo_truoc_phu">Trước phải</button>
            <button data-angle="goc_cheo_sau_lai">Sau trái</button>
            <button data-angle="goc_cheo_sau_phu">Sau phải</button>
            <button data-angle="goc_chinh_dien">Thẳng xe</button>
        </div>

        <div class="video-container">
            <video id="camera" autoplay playsinline></video>
            <img id="overlay" class="overlay" src="" alt="Khung hướng dẫn" style="display:none;" />
            <div class="info-overlay" id="deviceInfo">Đang lấy thông tin...</div>
            <button class="capture-btn" id="captureBtn">
                <img src="/Resources/camera.png" alt="Chụp" class="camera-icon" />
            </button>
        </div>

        <div class="instructions">Giữ camera thẳng, chọn góc chụp ở phía trên trước khi chụp. Tối đa 5 ảnh.</div>
        <div class="photo-count" id="photoCount">0 / 5 ảnh đã chụp</div>
        <div class="preview" id="preview"></div>
        <button id="uploadAllBtn">Upload tất cả ảnh</button>

        <div class="photo-guide">
            <p>Hãy chụp đầy đủ các góc và đủ sáng như các mẫu dưới đây:</p>
            <div class="guide-images">
                <img src="/Resources/chinh_dien.jpg" alt="Góc chính diện">
                <img src="/Resources/cheo_truoc_ben_lai.jpg" alt="Góc chéo trước bên lái">
                <img src="/Resources/cheo_sau_ben_lai.jpg" alt="Góc chéo sau bên lái">
                <img src="/Resources/cheo_truoc_ben_phu.jpg" alt="Góc chéo trước bên phụ">
                <img src="/Resources/cheo_sau_ben_phu.jpg" alt="Góc chéo sau bên phụ">
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <canvas id="canvas"></canvas>

    <!--<div id="lightbox" onclick="this.style.display='none'"><img id="lightboxImg"></div>-->
    <div id="lightbox">
        <span id="lightboxClose">&times;</span>
        <img id="lightboxImg" />
    </div>

    <script>
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const captureBtn = document.getElementById('captureBtn');
        const deviceInfoDiv = document.getElementById('deviceInfo');
        const photoCountDiv = document.getElementById('photoCount');
        const loadingOverlay = document.getElementById('loading');
        const toast = document.getElementById('toast');
        const uploadAllBtn = document.getElementById('uploadAllBtn');
        const lightboxImg = document.getElementById('lightboxImg');
        const angleButtons = document.querySelectorAll('#angleButtons button');

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        let locationData = { lat: null, lon: null };
        let deviceInfo = { userAgent: navigator.userAgent, platform: navigator.platform, ip: "Đang lấy..." };
        let photoNum = 0, MAX_PHOTOS = 5;
        let photos = [];
        let selectedAngle = null;
        let selectedAngleText = "";

        function showToast(msg, success = true) {
            toast.textContent = msg;
            toast.style.background = success ? "rgba(0,150,0,0.9)" : "rgba(220,0,0,0.9)";
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 2500);
        }

        angleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                angleButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAngle = btn.dataset.angle;
                selectedAngleText = btn.textContent;

                changeOverlay(selectedAngle);
            });
        });

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                loadingOverlay.style.display = "none";
            } catch (err) {
                loadingOverlay.querySelector(".loading-text").textContent = "Không thể truy cập camera!";
                console.error(err);
            }
        }

        function getLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(pos => {
                locationData.lat = pos.coords.latitude;
                locationData.lon = pos.coords.longitude;
                updateDeviceInfo();
            }, err => console.warn('Không lấy vị trí:', err.message));
        }

        async function getIP() {
            try {
                const res = await fetch("https://api.ipify.org?format=json");
                const data = await res.json();
                deviceInfo.ip = data.ip;
                updateDeviceInfo();
            } catch (err) { console.warn("Không lấy được IP", err); }
        }

        function updateDeviceInfo() {
            deviceInfoDiv.innerHTML = `
                 <strong>Thiết bị:</strong> ${deviceInfo.platform} - ${deviceInfo.model ?? "?"}<br>
                 <strong>Trình duyệt:</strong> ${detectBrowser()}<br>
                 <strong>IP:</strong> ${deviceInfo.ip}<br>
                 <strong>ID hợp đồng:</strong> ${id}<br>
                 <strong>Vĩ độ:</strong> ${locationData.lat ?? "?"} | <strong>Kinh độ:</strong> ${locationData.lon ?? "?"}
                 `;
        }

        function detectBrowser() {
            const ua = navigator.userAgent;
            if (ua.includes("Chrome") && ua.includes("Edg")) return "Microsoft Edge (Chromium)";
            if (ua.includes("Chrome")) return "Google Chrome";
            if (ua.includes("Firefox")) return "Mozilla Firefox";
            if (ua.includes("Safari") && !ua.includes("Chrome")) return "Safari";
            if (ua.includes("Opera") || ua.includes("OPR")) return "Opera";
            return "Trình duyệt không xác định";
        }

        function makeSafeName(angleKey) {
            const now = new Date();
            const pad = v => String(v).padStart(2, '0');
            const YYYY = now.getFullYear();
            const MM = pad(now.getMonth() + 1);
            const DD = pad(now.getDate());
            const hh = pad(now.getHours());
            const mm = pad(now.getMinutes());
            const ss = pad(now.getSeconds());
            return `${angleKey}_${id}.jpg`;
        }

        function isAngleCaptured(angle) {
            return photos.some(photo => photo.angle === angle);
        }

        captureBtn.addEventListener('click', async () => {
            if (!selectedAngle) return showToast('Hãy chọn góc chụp!', false);
            if (photos.length >= MAX_PHOTOS) return showToast(`Đã đủ ${MAX_PHOTOS} ảnh`, false);

            if (isAngleCaptured(selectedAngleText)) {
                return showToast(`Bạn đã chụp góc "${selectedAngleText}" rồi! Vui lòng chọn góc chụp khác.`, false);
            }

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            const timestamp = new Date().toLocaleString();
            const safeName = makeSafeName(selectedAngle);

            const photoObj = { dataUrl, angle: selectedAngleText, safeName, timestamp };
            photos.push(photoObj);

            const card = document.createElement('div');
            card.className = 'img-card';

            const img = document.createElement('img');
            img.src = dataUrl;
            img.alt = photoObj.safeName;
            img.addEventListener('click', () => { lightboxImg.src = dataUrl; lightbox.style.display = 'flex'; });

            const label = document.createElement('div');
            label.className = 'angle-label';
            label.textContent = photoObj.angle;

            const ts = document.createElement('div');
            ts.className = 'timestamp';
            ts.textContent = photoObj.timestamp;

            const del = document.createElement('div');
            del.className = 'delete-btn';
            del.textContent = '×';
            del.title = 'Xóa ảnh';
            del.addEventListener('click', (e) => {
                e.stopPropagation();
                preview.removeChild(card);
                photos = photos.filter(p => p !== photoObj);
                updatePhotoCount();
            });

            card.appendChild(img);
            card.appendChild(label);
            card.appendChild(ts);
            card.appendChild(del);
            preview.appendChild(card);

            updatePhotoCount();
        });

        function updatePhotoCount() { photoCountDiv.textContent = `${photos.length} / ${MAX_PHOTOS} ảnh đã chụp`; }

        uploadAllBtn.addEventListener("click", async () => {
            if (photos.length === 0) return showToast("Chưa có ảnh để upload!", false);

            loadingOverlay.style.display = "flex";
            loadingOverlay.querySelector(".loading-text").textContent = "Đang tải ảnh lên...";

            for (const photo of photos) {
                const blob = await (await fetch(photo.dataUrl)).blob();
                const file = new File([blob], photo.safeName, { type: 'image/jpeg' });
                const formData = new FormData();
                formData.append("file", file);
                formData.append("angle", photo.angle);
                formData.append("timestamp", photo.timestamp);

                try { await fetch("/upload", { method: "POST", body: formData }); }
                catch (err) { console.error("Upload lỗi:", err); showToast("❌ Lỗi khi tải lên!", false); }
            }

            loadingOverlay.style.display = "none";
            showToast("✔️ Tất cả ảnh đã được tải lên");

            photos = [];
            photoNum = 0;
            photoCountDiv.textContent = `0 / ${MAX_PHOTOS} ảnh đã chụp`;
            preview.innerHTML = "";
        });

        async function getDeviceModel() {
            if (navigator.userAgentData && navigator.userAgentData.getHighEntropyValues) {
                try {
                    const data = await navigator.userAgentData.getHighEntropyValues(["model", "platform", "platformVersion", "uaFullVersion"]);
                    deviceInfo.model = data.model || "Không xác định";
                    deviceInfo.platform = data.platform || deviceInfo.platform;
                    deviceInfo.uaFullVersion = data.uaFullVersion;
                    updateDeviceInfo();
                } catch (err) { console.warn("Không thể lấy model:", err); }
            } else { deviceInfo.model = "Không hỗ trợ (userAgentData)"; updateDeviceInfo(); }
        }

        document.querySelectorAll(".guide-images img").forEach(img => {
            img.addEventListener("click", () => {
                lightboxImg.src = img.src;
                lightbox.style.display = "flex";
            });
        });

        const overlay = document.getElementById("overlay");

        function changeOverlay(angle) {
            if (!angle) {
                overlay.style.display = "none";
                return;
            }

            let newSrc = "";
            switch (angle) {
                case "goc_chinh_dien":
                    newSrc = "/Resources/1.png";
                    break;
                case "goc_cheo_truoc_lai":
                    newSrc = "/Resources/2.png";
                    break;
                case "goc_cheo_sau_lai":
                    newSrc = "/Resources/5.png";
                    break;
                case "goc_cheo_truoc_phu":
                    newSrc = "/Resources/4.png";
                    break;
                case "goc_cheo_sau_phu":
                    newSrc = "/Resources/3.png";
                    break;
                default:
                    newSrc = "";
                    break;
            }

            if (newSrc) {
                overlay.src = newSrc;
                overlay.style.display = "block";
                overlay.style.opacity = 0.6;
            } else {
                overlay.style.display = "none";
            }
        }

        //-------------------------------------------------------------------------
        const lightbox = document.getElementById("lightbox");
        const lightboxClose = document.getElementById("lightboxClose");

        lightboxClose.addEventListener("click", () => {
            lightbox.style.display = "none";
        });

        document.querySelectorAll(".guide-images img, .img-card img").forEach(img => {
            img.addEventListener("click", () => {
                lightboxImg.src = img.src;
                lightbox.style.display = "flex";
            });
        });


        getDeviceModel();
        initCamera();
        getLocation();
        getIP();
        updateDeviceInfo();
    </script>
</body>
</html>
