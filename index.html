<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landing Page</title>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.has('id')) {
            const defaultId = "HDS2323i4i34232";
            const newUrl = window.location.href + (window.location.href.includes('?') ? '&' : '?') + 'id=' + defaultId;
            window.history.replaceState({}, '', newUrl);
        }
    </script>

    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>


</head>
<body>
    <div class="container">
        <div id="loading" class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">ƒêang kh·ªüi ƒë·ªông camera...</div>
        </div>

        <div class="angle-buttons" id="angleButtons">
            <button data-angle="goc_cheo_truoc_lai">Tr∆∞·ªõc tr√°i</button>
            <button data-angle="goc_cheo_truoc_phu">Tr∆∞·ªõc ph·∫£i</button>
            <button data-angle="goc_cheo_sau_lai">Sau tr√°i</button>
            <button data-angle="goc_cheo_sau_phu">Sau ph·∫£i</button>
            <button data-angle="goc_chinh_dien">Th·∫≥ng xe</button>
        </div>

        <div class="video-container">
            <video id="camera" autoplay playsinline></video>
            <img id="overlay" class="overlay" src="" alt="Khung h∆∞·ªõng d·∫´n" style="display:none;" />
            <div class="info-overlay" id="deviceInfo">ƒêang l·∫•y th√¥ng tin...</div>
            <button class="capture-btn" id="captureBtn">
                <img src="/Resources/camera.png" alt="Ch·ª•p" class="camera-icon" />
            </button>
        </div>

        <div class="instructions">Gi·ªØ camera th·∫≥ng, ch·ªçn g√≥c ch·ª•p ·ªü ph√≠a tr√™n tr∆∞·ªõc khi ch·ª•p. T·ªëi ƒëa 5 ·∫£nh.</div>
        <div class="photo-count" id="photoCount">0 / 5 ·∫£nh ƒë√£ ch·ª•p</div>
        <div class="preview" id="preview"></div>
        <button id="uploadAllBtn">Upload t·∫•t c·∫£ ·∫£nh</button>

        <div class="photo-guide">s
            <p>H√£y ch·ª•p ƒë·∫ßy ƒë·ªß c√°c g√≥c v√† ƒë·ªß s√°ng nh∆∞ c√°c m·∫´u d∆∞·ªõi ƒë√¢y. <br />
            L∆∞u √Ω: C√≥ th·ªÉ xem ·∫£nh sau khi ch·ª•p, N·∫øu kh√¥ng ƒë·∫°t y√™u c·∫ßu c√≥ th·ªÉ x√≥a ƒëi v√† ch·ª•p l·∫°i.</p>
            <div class="guide-images">
                <img src="/Resources/chinh_dien.jpg" alt="G√≥c ch√≠nh di·ªán">
                <img src="/Resources/cheo_truoc_ben_lai.jpg" alt="G√≥c ch√©o tr∆∞·ªõc b√™n l√°i">
                <img src="/Resources/cheo_sau_ben_lai.jpg" alt="G√≥c ch√©o sau b√™n l√°i">
                <img src="/Resources/cheo_truoc_ben_phu.jpg" alt="G√≥c ch√©o tr∆∞·ªõc b√™n ph·ª•">
                <img src="/Resources/cheo_sau_ben_phu.jpg" alt="G√≥c ch√©o sau b√™n ph·ª•">
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <canvas id="canvas"></canvas>

    <div id="lightbox">
        <span id="lightboxClose">&times;</span>
        <img id="lightboxImg" />
    </div>

    <script>
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const captureBtn = document.getElementById('captureBtn');
        const deviceInfoDiv = document.getElementById('deviceInfo');
        const photoCountDiv = document.getElementById('photoCount');
        const loadingOverlay = document.getElementById('loading');
        const toast = document.getElementById('toast');
        const uploadAllBtn = document.getElementById('uploadAllBtn');
        const lightboxImg = document.getElementById('lightboxImg');
        const angleButtons = document.querySelectorAll('#angleButtons button');

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        let locationData = { lat: null, lon: null };
        let deviceInfo = { userAgent: navigator.userAgent, platform: navigator.platform, ip: "ƒêang l·∫•y..." };
        let photoNum = 0, MAX_PHOTOS = 5;
        let photos = [];
        let selectedAngle = null;
        let selectedAngleText = "";

        document.body.classList.add('no-scroll');
        loadingOverlay.style.display = 'flex';

        let aiModel = null;

        async function loadAIModel() {
            aiModel = await cocoSsd.load();
            console.log("AI model loaded!");
        }
        loadAIModel();

        async function checkCar(imageElement) {
            if (!aiModel) return false;

            const predictions = await aiModel.detect(imageElement);

            console.log("Predictions:", predictions);

            return predictions.some(p =>
                (p.class === "car" || p.class === "truck") && p.score > 0.5
            );
        }

        function showToast(msg, success = true) {
            toast.textContent = msg;
            toast.style.background = success ? "rgba(0,150,0,0.9)" : "rgba(220,0,0,0.9)";
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 2500);
        }

        angleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                angleButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAngle = btn.dataset.angle;
                selectedAngleText = btn.textContent;

                changeOverlay(selectedAngle);
            });
        });

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                document.body.classList.remove('no-scroll');
                loadingOverlay.style.display = "none";
            } catch (err) {
                loadingOverlay.querySelector(".loading-text").textContent = "Kh√¥ng th·ªÉ truy c·∫≠p camera!";
                console.error(err);
            }
        }

        function getLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(pos => {
                locationData.lat = pos.coords.latitude;
                locationData.lon = pos.coords.longitude;
                updateDeviceInfo();
            }, err => console.warn('Kh√¥ng l·∫•y v·ªã tr√≠:', err.message));
        }

        async function getIP() {
            try {
                const res = await fetch("https://api.ipify.org?format=json");
                const data = await res.json();
                deviceInfo.ip = data.ip;
                updateDeviceInfo();
            } catch (err) { console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c IP", err); }
        }

        function updateDeviceInfo() {
            deviceInfoDiv.innerHTML = `
                 <strong>Thi·∫øt b·ªã:</strong> ${deviceInfo.platform} - ${deviceInfo.model ?? "?"}<br>
                 <strong>Tr√¨nh duy·ªát:</strong> ${detectBrowser()}<br>
                 <strong>IP:</strong> ${deviceInfo.ip}<br>
                 <strong>ID h·ª£p ƒë·ªìng:</strong> ${id}<br>
                 <strong>Vƒ© ƒë·ªô:</strong> ${locationData.lat ?? "?"} | <strong>Kinh ƒë·ªô:</strong> ${locationData.lon ?? "?"}
                 `;
        }

        function detectBrowser() {
            const ua = navigator.userAgent;
            if (ua.includes("Chrome") && ua.includes("Edg")) return "Microsoft Edge (Chromium)";
            if (ua.includes("Chrome")) return "Google Chrome";
            if (ua.includes("Firefox")) return "Mozilla Firefox";
            if (ua.includes("Safari") && !ua.includes("Chrome")) return "Safari";
            if (ua.includes("Opera") || ua.includes("OPR")) return "Opera";
            return "Tr√¨nh duy·ªát kh√¥ng x√°c ƒë·ªãnh";
        }

        function makeSafeName(angleKey) {
            return `${angleKey}_${id}.jpg`;
        }

        function isAngleCaptured(angle) {
            return photos.some(photo => photo.angle === angle);
        }

        //captureBtn.addEventListener('click', async () => {
        //    if (!selectedAngle) return showToast('H√£y ch·ªçn g√≥c ch·ª•p!', false);
        //    if (photos.length >= MAX_PHOTOS) return showToast(`ƒê√£ ƒë·ªß ${MAX_PHOTOS} ·∫£nh`, false);

        //    if (isAngleCaptured(selectedAngleText)) {
        //        return showToast(`B·∫°n ƒë√£ ch·ª•p g√≥c "${selectedAngleText}" r·ªìi! Vui l√≤ng ch·ªçn g√≥c ch·ª•p kh√°c.`, false);
        //    }

        //    const ctx = canvas.getContext('2d');
        //    canvas.width = video.videoWidth || 1280;
        //    canvas.height = video.videoHeight || 720;
        //    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        //    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        //    const timestamp = new Date().toLocaleString();
        //    const safeName = makeSafeName(selectedAngle);



        //    const photoObj = { dataUrl, angle: selectedAngleText, safeName, timestamp };
        //    photos.push(photoObj);

        //    const card = document.createElement('div');
        //    card.className = 'img-card';

        //    const img = document.createElement('img');
        //    img.src = dataUrl;
        //    img.alt = photoObj.safeName;
        //    img.addEventListener('click', () => { lightboxImg.src = dataUrl; lightbox.style.display = 'flex'; });

        //    const label = document.createElement('div');
        //    label.className = 'angle-label';
        //    label.textContent = photoObj.angle;

        //    const ts = document.createElement('div');
        //    ts.className = 'timestamp';
        //    ts.textContent = photoObj.timestamp;

        //    const del = document.createElement('div');
        //    del.className = 'delete-btn';
        //    del.textContent = '√ó';
        //    del.title = 'X√≥a ·∫£nh';
        //    del.addEventListener('click', (e) => {
        //        e.stopPropagation();
        //        preview.removeChild(card);
        //        photos = photos.filter(p => p !== photoObj);
        //        updatePhotoCount();
        //    });

        //    card.appendChild(img);
        //    card.appendChild(label);
        //    card.appendChild(ts);
        //    card.appendChild(del);
        //    preview.appendChild(card);

        //    updatePhotoCount();
        //});

        captureBtn.addEventListener('click', async () => {
            if (!selectedAngle) return showToast('H√£y ch·ªçn g√≥c ch·ª•p!', false);
            if (photos.length >= MAX_PHOTOS) return showToast(`ƒê√£ ƒë·ªß ${MAX_PHOTOS} ·∫£nh`, false);

            if (isAngleCaptured(selectedAngleText)) {
                return showToast(`B·∫°n ƒë√£ ch·ª•p g√≥c "${selectedAngleText}" r·ªìi! Vui l√≤ng ch·ªçn g√≥c ch·ª•p kh√°c.`, false);
            }

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // T·∫°o ·∫£nh t·∫°m ƒë·ªÉ AI detect
            const tempImg = new Image();
            tempImg.src = canvas.toDataURL('image/jpeg', 0.9);
            await new Promise(r => tempImg.onload = r);

            // üß† KI·ªÇM TRA XE B·∫∞NG AI
            const isCar = await checkCar(tempImg);

            if (!isCar) {
                return showToast("‚ùå Kh√¥ng ph√°t hi·ªán th·∫•y xe trong ·∫£nh. Vui l√≤ng ch·ª•p l·∫°i!", false);
            }

            // N·∫øu AI OK ‚Üí ti·∫øp t·ª•c logic c·ªßa b·∫°n
            const dataUrl = tempImg.src;
            const timestamp = new Date().toLocaleString();
            const safeName = makeSafeName(selectedAngle);

            const photoObj = { dataUrl, angle: selectedAngleText, safeName, timestamp };
            photos.push(photoObj);

            const card = document.createElement('div');
            card.className = 'img-card';

            const img = document.createElement('img');
            img.src = dataUrl;
            img.alt = photoObj.safeName;
            img.addEventListener('click', () => {
                lightboxImg.src = dataUrl;
                lightbox.style.display = 'flex';
            });

            const label = document.createElement('div');
            label.className = 'angle-label';
            label.textContent = photoObj.angle;

            const ts = document.createElement('div');
            ts.className = 'timestamp';
            ts.textContent = photoObj.timestamp;

            const del = document.createElement('div');
            del.className = 'delete-btn';
            del.textContent = '√ó';
            del.title = 'X√≥a ·∫£nh';
            del.addEventListener('click', (e) => {
                e.stopPropagation();
                preview.removeChild(card);
                photos = photos.filter(p => p !== photoObj);
                updatePhotoCount();
            });

            card.appendChild(img);
            card.appendChild(label);
            card.appendChild(ts);
            card.appendChild(del);
            preview.appendChild(card);

            updatePhotoCount();
        });


        function updatePhotoCount() { photoCountDiv.textContent = `${photos.length} / ${MAX_PHOTOS} ·∫£nh ƒë√£ ch·ª•p`; }

        uploadAllBtn.addEventListener("click", async () => {
            if (photos.length === 0) return showToast("Ch∆∞a c√≥ ·∫£nh ƒë·ªÉ upload!", false);

            loadingOverlay.style.display = "flex";
            loadingOverlay.querySelector(".loading-text").textContent = "ƒêang t·∫£i ·∫£nh l√™n...";

            for (const photo of photos) {
                const blob = await (await fetch(photo.dataUrl)).blob();
                const file = new File([blob], photo.safeName, { type: 'image/jpeg' });
                const formData = new FormData();
                formData.append("file", file);
                formData.append("angle", photo.angle);
                formData.append("timestamp", photo.timestamp);

                try { await fetch("/upload", { method: "POST", body: formData }); }
                catch (err) { console.error("Upload l·ªói:", err); showToast("‚ùå L·ªói khi t·∫£i l√™n!", false); }
            }

            loadingOverlay.style.display = "none";
            showToast("‚úîÔ∏è T·∫•t c·∫£ ·∫£nh ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n");

            photos = [];
            photoNum = 0;
            photoCountDiv.textContent = `0 / ${MAX_PHOTOS} ·∫£nh ƒë√£ ch·ª•p`;
            preview.innerHTML = "";
        });

        async function getDeviceModel() {
            if (navigator.userAgentData && navigator.userAgentData.getHighEntropyValues) {
                try {
                    const data = await navigator.userAgentData.getHighEntropyValues(["model", "platform", "platformVersion", "uaFullVersion"]);
                    deviceInfo.model = data.model || "Kh√¥ng x√°c ƒë·ªãnh";
                    deviceInfo.platform = data.platform || deviceInfo.platform;
                    deviceInfo.uaFullVersion = data.uaFullVersion;
                    updateDeviceInfo();
                } catch (err) { console.warn("Kh√¥ng th·ªÉ l·∫•y model:", err); }
            } else { deviceInfo.model = "Kh√¥ng h·ªó tr·ª£ (userAgentData)"; updateDeviceInfo(); }
        }

        document.querySelectorAll(".guide-images img").forEach(img => {
            img.addEventListener("click", () => {
                lightboxImg.src = img.src;
                lightbox.style.display = "flex";
            });
        });

        const overlay = document.getElementById("overlay");

        function changeOverlay(angle) {
            if (!angle) {
                overlay.style.display = "none";
                return;
            }

            let newSrc = "";
            switch (angle) {
                case "goc_chinh_dien":
                    newSrc = "/Resources/1.png";
                    break;
                case "goc_cheo_truoc_lai":
                    newSrc = "/Resources/2.png";
                    break;
                case "goc_cheo_sau_lai":
                    newSrc = "/Resources/5.png";
                    break;
                case "goc_cheo_truoc_phu":
                    newSrc = "/Resources/4.png";
                    break;
                case "goc_cheo_sau_phu":
                    newSrc = "/Resources/3.png";
                    break;
                default:
                    newSrc = "";
                    break;
            }

            if (newSrc) {
                overlay.src = newSrc;
                overlay.style.display = "block";
                overlay.style.opacity = 0.6;
            } else {
                overlay.style.display = "none";
            }
        }

        const lightbox = document.getElementById("lightbox");
        const lightboxClose = document.getElementById("lightboxClose");

        lightboxClose.addEventListener("click", () => {
            lightbox.style.display = "none";
        });

        document.querySelectorAll(".guide-images img, .img-card img").forEach(img => {
            img.addEventListener("click", () => {
                lightboxImg.src = img.src;
                lightbox.style.display = "flex";
            });
        });

        getDeviceModel();
        initCamera();
        getLocation();
        getIP();
        updateDeviceInfo();
    </script>
</body>
</html>
